name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  test:
    runs-on: ${{ matrix.os == 'alpine' && 'ubuntu-latest' || 'ubuntu-latest' }}
    container: ${{ matrix.os == 'alpine' && 'alpine:latest' || null }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # Ubuntu tests
          - name: "Ubuntu with PCRE2 + Coverage"
            os: ubuntu
            pcre2: true
            coverage: true
            configure_flags: "--with-pcre2"

          - name: "Ubuntu without PCRE2"
            os: ubuntu
            pcre2: false
            coverage: false
            configure_flags: "--without-pcre2"

          # Alpine (musl) tests
          - name: "Musl with PCRE2"
            os: alpine
            pcre2: true
            coverage: false
            configure_flags: "--with-pcre2"

          - name: "Musl without PCRE2"
            os: alpine
            pcre2: false
            coverage: false
            configure_flags: "--without-pcre2"

          # Windows cross-compilation tests
          - name: "Windows x86_64 (MinGW cross-compile)"
            os: ubuntu
            pcre2: false
            coverage: false
            configure_flags: "--host=x86_64-w64-mingw32 --without-pcre2"
            cross_compile: true
            mingw_target: "x86_64-w64-mingw32"

          - name: "Windows i686 (MinGW cross-compile)"
            os: ubuntu
            pcre2: false
            coverage: false
            configure_flags: "--host=i686-w64-mingw32 --without-pcre2"
            cross_compile: true
            mingw_target: "i686-w64-mingw32"

    name: ${{ matrix.name }}

    steps:
    - uses: actions/checkout@v4

    # Install dependencies - Ubuntu
    - name: Install dependencies (Ubuntu)
      if: ${{ matrix.os == 'ubuntu' && !matrix.cross_compile }}
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          autoconf \
          automake \
          build-essential \
          perl \
          patch \
          diffutils \
          xmlto \
          libpcre2-dev \
          gnulib \
          lcov

    # Install dependencies - Ubuntu with MinGW for cross-compilation
    - name: Install dependencies (Ubuntu + MinGW)
      if: ${{ matrix.os == 'ubuntu' && matrix.cross_compile }}
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          autoconf \
          automake \
          build-essential \
          perl \
          patch \
          diffutils \
          xmlto \
          gnulib \
          mingw-w64 \
          mingw-w64-tools

    # Install dependencies - Alpine with PCRE2
    - name: Install dependencies (Alpine with PCRE2)
      if: matrix.os == 'alpine' && matrix.pcre2
      run: |
        apk add --no-cache \
          build-base \
          autoconf \
          automake \
          perl \
          patch \
          diffutils \
          xmlto \
          pcre2-dev \
          bash \
          git \
          coreutils \
          python3

    # Install dependencies - Alpine without PCRE2
    - name: Install dependencies (Alpine without PCRE2)
      if: matrix.os == 'alpine' && !matrix.pcre2
      run: |
        apk add --no-cache \
          build-base \
          autoconf \
          automake \
          perl \
          patch \
          diffutils \
          xmlto \
          bash \
          git \
          coreutils \
          python3

    # Bootstrap - Ubuntu
    - name: Bootstrap
      if: matrix.os == 'ubuntu'
      run: ./bootstrap

    # Bootstrap - Alpine
    - name: Bootstrap (Alpine)
      if: matrix.os == 'alpine'
      run: |
        ./gnulib-update.sh
        export PATH="/tmp/gnulib:$PATH"
        ./bootstrap

    # Configure
    - name: Configure
      run: |
        CFLAGS_EXTRA=""
        LDFLAGS_EXTRA=""

        if [ "${{ matrix.coverage }}" = "true" ]; then
          CFLAGS_EXTRA="--coverage -g -O0"
          LDFLAGS_EXTRA="--coverage"
        fi

        ./configure ${{ matrix.configure_flags }} \
          ${CFLAGS_EXTRA:+CFLAGS="$CFLAGS_EXTRA"} \
          ${LDFLAGS_EXTRA:+LDFLAGS="$LDFLAGS_EXTRA"}

    # Build
    - name: Build
      run: make -j$(nproc)

    # Test (skip for cross-compilation since we can't run Windows binaries on Linux)
    - name: Run tests
      if: ${{ !matrix.cross_compile }}
      run: make check

    # For cross-compilation, just verify the binaries were created
    - name: Verify Windows binaries (cross-compile)
      if: ${{ matrix.cross_compile }}
      run: |
        echo "Verifying Windows binaries were created..."
        ls -la src/
        file src/interdiff.exe || file src/interdiff
        file src/filterdiff.exe || file src/filterdiff
        file src/rediff.exe || file src/rediff
        echo "Cross-compilation successful!"

    # Coverage reporting (only for coverage builds)
    - name: Generate coverage report
      if: matrix.coverage
      run: |
        # Create coverage directory
        mkdir -p coverage

        # Capture coverage data with geninfo options to handle warnings
        lcov --capture --directory . --output-file coverage/coverage.info --rc geninfo_unexecuted_blocks=1

        # Remove coverage data for system headers, lib files, and test files
        lcov --remove coverage/coverage.info '/usr/*' '*/lib/*' '*/tests/*' --output-file coverage/coverage_filtered.info --ignore-errors unused

        # Generate HTML report
        genhtml coverage/coverage_filtered.info --output-directory coverage/html

        # Generate summary for CI and extract coverage percentage
        lcov --summary coverage/coverage_filtered.info > coverage/summary.txt

        # Extract coverage percentage for badge (using awk for more reliable parsing)
        COVERAGE=$(awk '/lines\.+:/ {gsub(/[()%]/, "", $2); print $2}' coverage/summary.txt)
        echo "COVERAGE_PERCENT=$COVERAGE" >> $GITHUB_ENV
        echo "Coverage: $COVERAGE%"

        # Extract detailed coverage info for PR comments
        LINES_COVERED=$(awk '/lines\.+:/ {print $3 " " $4 " " $5}' coverage/summary.txt | tr -d '()')
        FUNCTIONS_COVERED=$(awk '/functions\.+:/ {print $3 " " $4 " " $5}' coverage/summary.txt | tr -d '()')
        echo "LINES_COVERED=$LINES_COVERED" >> $GITHUB_ENV
        echo "FUNCTIONS_COVERED=$FUNCTIONS_COVERED" >> $GITHUB_ENV

    - name: Upload coverage to Codecov
      if: matrix.coverage
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage/coverage_filtered.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    # Show failures
    - name: Show test results on failure
      if: failure()
      run: |
        echo "=== Test logs ==="
        find . -name "*.log" -type f -exec echo "=== {} ===" \; -exec cat {} \;
        echo "=== Test arena contents ==="
        find test-arena -type f 2>/dev/null | head -20 | while read f; do
          echo "=== $f ==="
          cat "$f" 2>/dev/null || echo "Cannot read file"
        done

  # Separate distcheck job (doesn't fit well in matrix)
  distcheck:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          autoconf \
          automake \
          build-essential \
          perl \
          patch \
          diffutils \
          xmlto \
          libpcre2-dev \
          gnulib

    - name: Bootstrap
      run: ./bootstrap

    - name: Configure
      run: ./configure --with-pcre2

    - name: Build and test distribution
      run: make distcheck

    - name: Show test results on failure
      if: failure()
      run: |
        echo "=== Test logs ==="
        find . -name "*.log" -type f -exec echo "=== {} ===" \; -exec cat {} \;
        echo "=== Test arena contents ==="
        find test-arena -type f 2>/dev/null | head -20 | while read f; do
          echo "=== $f ==="
          cat "$f" 2>/dev/null || echo "Cannot read file"
        done

  # Native Windows build using MSYS2
  windows-native:
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Windows MSYS2 MINGW64"
            msystem: MINGW64
            arch: x86_64
          - name: "Windows MSYS2 MINGW32"
            msystem: MINGW32
            arch: i686

    name: ${{ matrix.name }}

    defaults:
      run:
        shell: msys2 {0}

    steps:
    - uses: actions/checkout@v4

    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: ${{ matrix.msystem }}
        update: true
        install: >-
          base-devel
          mingw-w64-${{ matrix.arch }}-toolchain
          mingw-w64-${{ matrix.arch }}-autotools
          mingw-w64-${{ matrix.arch }}-pcre2
          autoconf-wrapper
          automake-wrapper
          perl
          patch
          diffutils

    - name: Bootstrap
      run: ./bootstrap

    - name: Configure
      run: ./configure --with-pcre2

    - name: Build
      run: make -j$(nproc)

    - name: Run tests
      run: make check

    - name: Show test results on failure
      if: failure()
      run: |
        echo "=== Test logs ==="
        find . -name "*.log" -type f -exec echo "=== {} ===" \; -exec cat {} \;
        echo "=== Test arena contents ==="
        find test-arena -type f 2>/dev/null | head -20 | while read f; do
          echo "=== $f ==="
          cat "$f" 2>/dev/null || echo "Cannot read file"
        done