#!/bin/sh

# Test runner for patch scanner unit tests
# This script must be run via 'make check' to ensure proper environment setup

# Check that we're running in the proper test environment
if [ -z "$top_srcdir" ] || [ -z "$top_builddir" ]; then
    echo "Error: This test must be run via 'make check'"
    echo "The top_srcdir and top_builddir variables must be set by the build system"
    exit 1
fi

# Convert top_srcdir to absolute path before common.sh changes working directory
top_srcdir="$(cd "$top_srcdir" && pwd)"

# Source the common test environment
. "$top_srcdir/tests/common.sh"

# Scanner tests are now built by the main build system
# Just verify they exist
echo "Checking scanner test programs..."
for test_prog in test_basic test_accumulated_headers test_input_validation; do
    if [ ! -x "$top_builddir/tests/scanner/$test_prog" ]; then
        echo "Error: Scanner test program $test_prog not found or not executable"
        echo "Make sure the main build system has built the scanner tests"
        exit 1
    fi
done

# Run the scanner tests
echo "Running patch scanner unit tests..."
cd "$top_builddir"
tests/scanner/test_basic || {
    echo "Scanner basic tests failed"
    exit 1
}

tests/scanner/test_accumulated_headers || {
    echo "Scanner accumulated headers tests failed"
    exit 1
}

tests/scanner/test_input_validation || {
    echo "Scanner input validation tests failed"
    exit 1
}

echo "âœ“ Scanner tests passed"
exit 0
